{% extends "base.html" %}
{% block title %}Cadastrar novo usuário - Viva Pet{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='src/css/cadastrar.css') }}">
{% endblock %}

{% block content %}
<div class="container cadastro-container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-10">
            <div class="card shadow cadastro-card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Crie sua conta</h2>
                    <form id="cadastroForm" autocomplete="off">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="username" class="form-label">Username *</label>
                                <input type="text" class="form-control" id="username" name="username" required maxlength="50">
                            </div>
                            <div class="col-md-6">
                                <label for="nome_user" class="form-label">Nome completo *</label>
                                <input type="text" class="form-control" id="nome_user" name="nome_user" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">E-mail *</label>
                                <input type="email" class="form-control" id="email" name="email" required maxlength="150">
                            </div>
                            <div class="col-md-6">
                                <label for="cpf" class="form-label">CPF *</label>
                                <input type="text" class="form-control" id="cpf" name="cpf" required maxlength="15" pattern="[\d.-]+">
                            </div>
                            <div class="col-md-6">
                                <label for="cep" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="cep" name="cep" maxlength="9">
                            </div>
                            <div class="col-md-6">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone" name="telefone" maxlength="15">
                            </div>
                            <div class="col-md-6">
                                <label for="pets" class="form-label">Pets <span class="small">(separados por vírgula)</span></label>
                                <input type="text" class="form-control" id="pets" name="pets" placeholder="Rex, Bela, Tobby">
                            </div>
                            <div class="col-md-6">
                                <label for="senha" class="form-label">Senha *</label>
                                <input type="password" class="form-control" id="senha" name="senha" required minlength="6">
                            </div>
                        </div>
                        <button type="submit" class="btn viva-btn-destaque mt-4 w-100">Cadastrar</button>
                        <div id="cadastroMessage" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('cadastroForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const messageDiv = document.getElementById('cadastroMessage');
    messageDiv.innerHTML = '';

    const payload = {
        username: document.getElementById('username').value.trim(),
        nome_user: document.getElementById('nome_user').value.trim(),
        email: document.getElementById('email').value.trim(),
        cpf: document.getElementById('cpf').value.trim(),
        cep: document.getElementById('cep').value.trim(),
        telefone: document.getElementById('telefone').value.trim(),
        pets: document.getElementById('pets').value.trim(),
        senha: document.getElementById('senha').value
    };

    try {
        const resp = await fetch("{{ url_for('usuarios.create_usuario') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (resp.ok) {
            messageDiv.className = 'alert alert-success';
            messageDiv.innerText = 'Cadastro realizado com sucesso!';
            document.getElementById('cadastroForm').reset();
        } else {
            messageDiv.className = 'alert alert-danger';
            messageDiv.innerText = (data && data.errors)
                ? Object.values(data.errors).join(' | ')
                : (data.message || 'Erro ao cadastrar usuário');
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerText = 'Erro inesperado ao cadastrar.';
    }
});
</script>
{% endblock %}